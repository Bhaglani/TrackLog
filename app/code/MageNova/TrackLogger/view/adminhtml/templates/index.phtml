<?php
/** @var \MageNova\TrackLogger\Block\Adminhtml\Logs $block */
/** @var \Magento\Framework\Escaper $escaper */
$escaper = $block->getEscaper();
?>
<div class="admin__field">
    <label for="log_file" class="admin__field-label">
        <span><?= $escaper->escapeHtml(__('Select Log File')) ?></span>
    </label>
    <div class="admin__field-control">
        <select id="log_file" name="log_file" class="admin__control-select" style="min-width:250px;">
            <option value=""><?= $escaper->escapeHtml(__('-- Select Log File --')) ?></option>
            <?php foreach ($block->getLogFiles() as $value => $label): ?>
                <option value="<?= $escaper->escapeHtmlAttr($value) ?>">
                    <?= $escaper->escapeHtml($label) ?>
                </option>
            <?php endforeach; ?>
        </select>
        <button id="download_log" class="action-default scalable" style="margin-left:10px;">
            <span><?= $escaper->escapeHtml(__('Download')) ?></span>
        </button>
    </div>
</div>
<div id="log-output"
     style="margin-top:20px; background:#f9f9f9; padding:10px; border:1px solid #ddd;
            height:500px; overflow:auto; font-family:monospace; white-space:pre-wrap;">
    <em><?= $escaper->escapeHtml(__('Select a log file to view last 1000 lines...')) ?></em>
</div>
<script>
require(['jquery'], function ($) {
    'use strict';
    const ajaxUrl = '<?= $escaper->escapeJs($block->getAjaxUrl()) ?>';
    const downloadUrl = '<?= $escaper->escapeJs($block->getUrl("magenovalog/log/download")) ?>';
    $('#log_file').on('change', function () {
        const file = $(this).val();
        if (file) {
            $('#log-output').html('<em>Loading...</em>');
            $.ajax({
                url: ajaxUrl,
                data: {file: file},
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        $('#log-output').text(response.content);
                    } else {
                        $('#log-output').html(
                            '<strong style="color:red;">' + response.message + '</strong>'
                        );
                    }
                },
                error: function () {
                    $('#log-output').html('<strong style="color:red;">Error loading log file.</strong>');
                }
            });
        } else {
            $('#log-output').html(
                '<em>Select a log file to view last 1000 lines...</em>'
            );
        }
    });
    $('#download_log').on('click', function () {
        const file = $('#log_file').val();
        if (file) {
            window.location.href = downloadUrl + '?file=' + encodeURIComponent(file);
        } else {
            alert('Please select a log file first.');
        }
    });
});
</script>